<!-- 
  @Author: Ryan Scherbarth
  @Date: 10/15/2020
  @Contact: ryan@ryanscherbarth.com
 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find a location</title>

  <script>
    var API_KEY = 'AIzaSyBwsSIVLU_0NgCSbr4ww1j-n_zaqWrM_S8';
    var GOOGLE_SHEET = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaUjtO_tH1bC35QFWGaHd1kZleUFCeKwegB6DHS_MSV6D0WwFvPbK2X8k7tBdEirlgRQaXV8HxbTuY/pubhtml'
  </script>
  <!-- Google Maps API Script -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwsSIVLU_0NgCSbr4ww1j-n_zaqWrM_S8&callback=initMap"
    async defer></script>
</head>

  <!-- 

    A locaiton page. Since this is to be used with a website created on wix, I have to get creative with where I store my data. To get around this 
    I am using a google sheet above as a database. I can just make this document public since there is no private information to be stored on it and 
    send a request as soon as the user loads the page to populate the locations. 

    I am using a google maps api key to send requests to the maps api. this is how I am able to display the map in the first place, as well as add markers
    for the locations to it. Both of these are stored in variables above.

    The data from my implementation of a database is handled in the scripts functions below. I do a fetch for the google sheet upon page load, and then feed 
    that into a helper method that parses the data, formats it, and dumps it into the display container. it then adds plot points for each of these locations 
    on the map. 

    Users will also have a link to an airtable, where they are able to add new locations to the database. This will then send an email to the admins of the site, 
    and with one click can be approved. After approved it will be concatendated to the bottom of the google sheets, and will then be displayed for all users to 
    access the site following that point. 

    The limitations from adding on to a pre-existing wix site provide some unique challenges to work around, namely the database. It is for this same reason that
    I have to place all of my css styling inline, as an addition to the wix site cannot have multiple files.

  -->

<body>
  
  <!--  Map container -->
  <div id="container">
    <div id="map"></div>

    <!-- List of locations -->
    <div id="locationTable">
      <h2>Locations</h2>
      <table>
        <thead>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Address</th>
            <th>Phone</th>
          </tr>
        </thead>
        <tbody id="locationData"></tbody>
      </table>
    </div>
  </div>

  <!-- Show pages for each location -->
  <!-- List of locations -->
  <div id="locationTable">
    <h2>Locations</h2>
    <table>

    </table>
  </div>

  <!-- Fetch Data Button -->
<button onclick="fetchData()">Fetch Data</button>

<!-- Container for Data -->
<div id="dataContainer">
  <h2>Data from Google Sheet</h2>
  <table>
    <thead>
      <tr>
        <th>Photo</th>
        <th>Name</th>
        <th>Address</th>
        <th>Phone</th>
      </tr>
    </thead>
    <tbody id="locationData"></tbody>
  </table>
</div>
</body>

</html>





<!-- Misc Functions / JavaScript -->
<script>
  // Initialize the map
  function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 35.12384, lng: -106.62723 }, // Center of Albuquerque
      zoom: 11, // Adjust the zoom level as needed
      // Customize the map options
      disableDefaultUI: true, // Disables all default UI controls
      zoomControl: true, // Enables the zoom control
    });
  }

  function fetchData() {
    console.log('Fetching data...');
    const dataContainer = document.getElementById('locationData');

    // Make a request to the Google Sheet
    fetch(GOOGLE_SHEET)
      .then((response) => response.text())
      .then((data) => {
        // Process the data here and populate the dataContainer
        console.log('Data fetched:', data);
        parseGoogleSheetData(data, dataContainer);
      })
      .catch((error) => {
        console.error('Error fetching data:', error);
      });
    console.log('Done fetching data.');
  }

  /*
    Parses the data from the request above and populates into the container 

    The request returns the entire HTML request, we start by jumping to the final line of the return 
    which contains the body of the html request. Each row is in the format:
    <tr style="height: 20px"><th id="0R0" style="height: 20px;" class="row-headers-background row-header-shim"><div class="row-header-wrapper" style="line-height: 20px">1</div></th><td class="s0">Location 1</td><td class="s0">Location 2</td><td class="s0">Location 3</td></tr>
    
    - loop through until we find "class="sX">...</td> where X is the column number. there is one location on each column.
    - extract the location name from the <td> tag
    - store the location name in an array for the column number
    - repeat until the end of file is reached, then dumb into the container.
  */
  function parseGoogleSheetData(data, container) {
  // Use regular expressions to find entries with the format "class="sX">...</td>"
  const regex = /class="s(\d+)">([^<]+)<\/td>/g;

  // Initialize an object to store data for each index
  const dataByIndex = {};

  // Iterate through the data using regular expressions
  let match;
  while ((match = regex.exec(data)) !== null) {
    const index = match[1];
    const value = match[2];

    // Create an array for the index if it doesn't exist
    if (!dataByIndex[index]) {
      dataByIndex[index] = [];
    }

    // Push the value into the array for the corresponding index
    dataByIndex[index].push(value);
  }

  // Create the HTML rows and populate the table
  const htmlRows = [];
  for (const index in dataByIndex) {
    const rowData = `
      <tr>
        <td><img src="resources/placehold.jpg" alt="Location ${index} Photo" width="100" height="100"></td>
        <td>Location ${index}</td>
        <td>${dataByIndex[index].join('</td><td>')}</td>
      </tr>
    `;
    htmlRows.push(rowData);
  }

  // Display the table rows in the container
  container.innerHTML = htmlRows.join('');
  }


</script>






<!-- CSS -->
<style>
  #map {
    width: 70%;
    /* Set the width to 70% the total screen size */
    height: 60vh;
    /* Set height to be 70% the total height as well */
    border-radius: 15px;
    /* round the corners of the map */
    margin-left: 5%;
    /* leave a small space on the left side */
    margin-right: 10%;
    /* Extra space on the right side so we can list the options as well */
    float: left;
    /* Float the map container to the left */
  }

  #locationTable {
    width: 50%;
    float: left;
    /* Change the float property to "left" to move it to the right */
  }

  /* Container to align elements horizontally */
  #container {
    display: flex;
    flex-direction: row;
  }
</style>